%! Package = palettize-boxes
%! Author = Jander Moreira
%! Date = 2024

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{palettize-boxes}[2024/08/01 v0.1 Puts itemized lists in boxes]

\input{palettize-options}

\ifbool{plt@HandwritingSupport}{
    \RequirePackage{emerald}
    \RequirePackage[T1]{fontenc}
}{}

\RequirePackage{varwidth}
\RequirePackage{tcolorbox}
\tcbuselibrary{raster, skins}
\usetikzlibrary{calc, decorations.pathmorphing}

\RequirePackage{palettize-base}
\RequirePackage{palettize-getitems}

% Check for class beamer
\newbool{plt@UsingBeamer}
\@ifclassloaded{beamer}{
    \booltrue{plt@UsingBeamer}
    \PackageWarning{palettize}{Using beamer support.}
}{
    \boolfalse{plt@UsingBeamer}
}

% Keys
\pgfkeys{
    palettize/.cd,
%
% numbering
    alph/.code = {\csdef{PLTCounterStyle}{\alph}},
    Alph/.code = {\csdef{PLTCounterStyle}{\Alph}},
    arabic/.code = {\csdef{PLTCounterStyle}{\arabic}},
    fnsymbol/.code = {\csdef{PLTCounterStyle}{\fnsymbol}},
    roman/.code = {\csdef{PLTCounterStyle}{\roman}},
    Roman/.code = {\csdef{PLTCounterStyle}{\Roman}},
%
%
    remember/.code = {%
        \csdef{plt@ContextName}{#1}%
        \booltrue{plt@RememberContext}%
    },
    continue/.code = {%
        \csdef{plt@ContextName}{#1}%
        \booltrue{plt@ContinueContext}%
    },
%
% box options
    box set/.code = {%
        \tcbset{raster every box/.style = {#1}}%
    },
    box/.code = {%
        \tcbset{raster every box/.append style = {#1}}%
    },
%
% raster options
    raster set/.code = {%
        \tcbset{raster base style/.style = {#1}}%
    },
    raster/.code = {%
        \tcbset{raster base style/.append style = {#1}}%
    },
%
% raster shortcuts
    columns/.code = {%
        \pgfkeysalso{raster = {raster columns = #1}}%
    },
    equal height/.code = {%
        \pgfkeysalso{raster = {raster equal height = #1}}%
    },
    raster valign/.code = {%
        \pgfkeysalso{raster = {raster valign = #1}}%
    },
    raster halign/.code = {%
        \pgfkeysalso{raster = {raster halign = #1}}%
    },
%
% color box shortcuts
    box valign/.code = {%
        \pgfkeysalso{box = {valign = #1}}%
    },
    box halign/.code = {%
        \pgfkeysalso{box = {halign = #1}}%
    },
%
% any style is handled here
    .unknown/.code = {%
        \csedef{plt@local@BoxStyle}{
            /tcb/raster every box/.style = {\pgfkeyscurrentname}
        }%
        \pgfkeysalsofrom{\plt@local@BoxStyle}%
    }
}

\tcbset{
% boxes
    itemize/.style = {
        enhanced,
        left = 0.25em,
        right = 0.25em,
        top = 0.5em,
        bottom = 0.5em,
        boxrule = 0.1em,
        colframe = PLTBGColor!40!black,
        interior style={
            top color = PLTBGColor!90!black,
            bottom color = PLTBGColor!80,
        },
        valign = top,
        halign = flush left,
        halign lower = flush left,
        halign title = flush left,
        rounded corners,
        fontupper = \sffamily\color{PLTFGColor},
        fontlower = \sffamily\color{PLTFGColor},
        fonttitle = \sffamily\color{PLTFGColor!10},
    },
    enumerate/.style = {
        itemize,
        enlarge top by = 1em,
        enlarge left by = 1em,
        add to width = -1em,
        lefttitle = 0.8em,
        overlay = {
            \coordinate (North West) at ($(frame.north west) + (0.05em, -0.05em)$);
            \path [fill = PLTBGColor!40!black] (North West) circle (1em);
            \path [thick, draw = PLTBGColor] (North West) circle (0.9em);
            \path [draw = PLTBGColor!40!black, line width = 0.1em, ] ($(frame.north west) + (1.15em, -0.05em)$) -- ++(-0.1em, 0) arc (0:270:1em) -- ++(0, -0.1em);
            \node[align = center, text = PLTFGColor!10] at ($(frame.north west) + (0.05em, -0.05em)$) {\PLTCounterStyle{tcbrasternum}};
        },
    },
    handwriting/.style = {
        itemize,
        halign title = flush left,
        opacityframe = 0,
        opacityback = 0,
        fontupper = \ifplt@HandwritingSupport\ECFJD\fi\color{PLTBGColor!50!black},
        fontlower = \ifplt@HandwritingSupport\ECFJD\fi\color{PLTBGColor!50!black},
        fonttitle = \ifplt@HandwritingSupport\ECFJD\fi\color{PLTBGColor!30!black},
        overlay = {
            \path[
                decorate,
                decoration = {
                    random steps,
                    segment length = 3pt,
                    amplitude = 0.3pt,
                },
                ultra thick,
                draw = none,
                fill = black,
                opacity = 0.3,
            ] ($(interior.north east) + (0.2em, -0.2em)$) -- ($(interior.south east) + (0.2em, -0.2em)$) -- ($(interior.south west) + (0.2em, -0.2em)$) -- ($(interior.north west) + (0.2em, -0.2em)$) -- cycle;
            \path[
                decorate,
                decoration = {
                    random steps,
                    segment length = 3pt,
                    amplitude = 0.3pt,
                },
                fill = PLTBGColor!15,
            ] (interior.north east) -- (interior.south east) -- (interior.south west) -- (interior.north west) -- cycle;
        },
    },
    day/.style = {
        enhanced,
        size = small,
        fontupper = \sffamily\color{PLTOuterFGColor},
        fontlower = \sffamily\color{PLTOuterBGColor},
        fonttitle = \ttfamily\color{PLTOuterFGColor},
        opacityframe = 0,
        opacityback = 0,
        valign = center,
        halign = flush left,
        enlarge left by = 1em,
        add to width = -1em,
        left = 1em,
        right = 0.25em,
        top = 0.25em,
        bottom = 0.2em,
        detach title,
        overlay = {
            \begin{scope}[shift = (interior.west)]
                %\draw[PLTOuterFGColor!70, very thin] (0, 0) circle (1em);
                \foreach \line in {1, ..., 8}{
                    \pgfmathsetmacro{\length}{145 - 90 * rnd}
                    \pgfmathsetmacro{\thickness}{0.15 - 0.1 * rnd}
                    \pgfmathsetmacro{\rotation}{360 * rnd}
                    \pgfmathsetmacro{\radius}{1 - 0.5 * \thickness}
                    \pgfmathsetmacro{\mix}{100 - 80 * rnd}
                    \draw [
                        PLTOuterFGColor!\mix!PLTOuterBGColor,
                        line width = \thickness * 1em,
                        radius = \radius * 1em,
                        line cap = round, rotate = \rotation,
                        opacity = 0.7,
                    ] ($(\radius * 1em, 0)$) arc[start angle=0, end angle=\length] (0: 1em);
                }
                \node[align = center] at (interior.west) {\tcbtitle};
            \end{scope}
        },
    },
    month/.style = {
        itemize,
        fonttitle = \scshape\color{PLTBGColor!10},
        boxrule = 0pt,
        halign title = center,
        interior style = {
            top color = PLTBGColor!90,
            bottom color = PLTBGColor!60,
        },
        valign = top,
        sharp corners,
        rounded corners = south,
        drop fuzzy shadow southeast = PLTBGColor!50!black,
    },
}

\PLTSet{
    day schedule/.style = {day, columns = 1},
    month schedule/.style = {month, columns = 4},
}

% Variables
%\newcounter{PLTBoxNumber}
%\newcounter{plt@SaveBoxNumber}
\newbool{plt@RememberContext}%
\boolfalse{plt@RememberContext}%
\newbool{plt@ContinueContext}%
\boolfalse{plt@ContinueContext}%

% Defaults
\PLTSet{
    itemize,
    arabic,
    raster set = {
        %nobeforeafter,
        raster force size = false,
    },
    columns = 3,
    equal height = rows,
    raster valign = top,
    raster halign = center,
    %continue = false,
}


% Code
\NewDocumentCommand{\plt@ShowColorBox}{ +m }{%
    \begin{tcolorbox}[plt@@single item]
        #1%
    \end{tcolorbox}%
}
\NewDocumentCommand{\plt@ShowItem}{ m m m +m m }{%
    \PLTIfType{#1}{B, AB}{%
        \tcbset{plt@@single item/.append style = {squeezed title = {#3}}}%
    }{%
        \tcbset{plt@@single item/.append style = {}}%
    }%
    \ifbool{plt@UsingBeamer}{%
        \PLTIfType{#1}{A, AB}{%
            \visible<#2>{#5{#4}}%
        }{%
            #5{#4}%
        }%
    }{%
        #5{#4}%
    }%
}

\NewDocumentEnvironment{PLTBoxRaster}{ O{} +b }{%
    \noindent%
    \begingroup%
    \PLTGatherItems{#2}%
    \colorlet{PLTOuterFGColor}{PLTFGColor}%
    \colorlet{PLTOuterBGColor}{PLTBGColor}%
    \PLTResetLoop%
    \PLTSet{#1}%
    \begin{varwidth}{\linewidth}%
        \vspace*{0.5em}%
        \begin{tcbraster}[raster base style]
            \ifbool{plt@ContinueContext}{%
                \defcounter{tcbrasternum}{\csuse{plt@ContextBoxNumber@\plt@ContextName}}%
                \boolfalse{plt@ContinueContext}%
                \booltrue{plt@RememberContext}%
            }{}%
            \PLTMapInline{%
                %\stepcounter{PLTBoxNumber}%
                %\defcounter{plt@SaveBoxNumber}{\thePLTBoxNumber}%
                \PLTParseItemFromMacro{\typeopt}{\angleopt}{\bracketopt}{\body}{\PLTInlineItem}%
                \tcbset{plt@@single item/.style = {}}%
                \plt@ShowItem{\typeopt}{\angleopt}{\bracketopt}{\body}{\plt@ShowColorBox}%
                %\defcounter{PLTBoxNumber}{\theplt@SaveBoxNumber + 2}%
                \PLTNextColor%
            }%
            \ifbool{plt@RememberContext}{%
                \global\csedef{plt@ContextBoxNumber@\plt@ContextName}{\thetcbrasternum}
                \boolfalse{plt@RememberContext}%
            }{}
        \end{tcbraster}%
        \vspace*{0.5em}%
    \end{varwidth}%
    \endgroup%
    }{%
}

%\NewDocumentEnvironment{PLTBox}{ O{itemize} +b }{%
%    \begingroup%
%    \PLTGatherItems{#2}%
%    \PLTResetLoop%
%    \defcounter{plt@BoxNumber}{0}
%    \tcbset{plt@@single item/.style = {#1}}%
%    \PLTMapInline{%
%        \stepcounter{plt@BoxNumber}
%        \PLTParseItemFromMacro{\typeopt}{\angleopt}{\bracketopt}{\body}{\PLTInlineItem}%
%        \plt@ShowItem{\typeopt}{\angleopt}{\bracketopt}{\body}{\plt@ShowColorBox}%
%        \PLTNextColor%
%    }
%    }{%
%    \endgroup
%}


\endinput