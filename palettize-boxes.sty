%! Package = palettize-boxes
%! Author = Jander Moreira
%! Date = 2024

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{palettize-boxes}[2024/08/01 v0.1 Puts itemized lists in boxes]

\input{palettize-options}

\RequirePackage{tcolorbox}
\tcbuselibrary{raster, skins}
\usetikzlibrary{calc}

\RequirePackage{palettize-base}
\RequirePackage{palettize-getitems}

% Check for class beamer
\newbool{plt@UsingBeamer}
\@ifclassloaded{beamer}{
    \booltrue{plt@UsingBeamer}
    \PackageWarning{palettize}{Using beamer support.}
}{
    \boolfalse{plt@UsingBeamer}
}

% Keys
\pgfkeys{
    palettize boxes/.cd,
%%
%    itemize/.code = {%
%        \tcbset{raster every box/.style = {itemize}}%
%        \csdef{plt@BoxWidthFix}{\plt@BoxWidthFixitemize}%
%    },
%    enumerate/.code = {%
%        \tcbset{raster every box/.style = {enumerate}}%
%        \csdef{plt@BoxWidthFix}{\plt@BoxWidthFixenumerate}%
%    },
%
    box style/.code = {%
        \tcbset{raster every box/.append style = {#1}}%
    },
    raster style/.code = {%
        \tcbset{raster options/.append style = {#1}}%
    },
%
    .unknown/.code = {%
        \csedef{plt@local@BoxStyle}{
            /tcb/raster every box/.style = {\pgfkeyscurrentname}
        }%
        \pgfkeysalsofrom{\plt@local@BoxStyle}%
    }
}

\NewDocumentCommand{\PLTBoxSet}{ >{ \TrimSpaces } m }{%
    \pgfkeys{palettize boxes/.cd, #1}%
}


% Styles

\newlength{\plt@RasterWidth}
\setlength{\plt@RasterWidth}{\linewidth}
\tcbset{
    box width fix/.code 2 args = {%
        \csdef{plt@BoxWidthFix#1}{#2}%
    },
    raster width fix/.code = {%
        \setlength{\plt@RasterWidth}{\dimexpr \kvtcb@raster@width - (\plt@BoxWidthFix) * \kvtcb@raster@columns}%
        \pgfkeysalso{raster width = \plt@RasterWidth}%
    },
}


\tcbset{
% boxes
    itemize/.style = {
        enhanced,
        left = 0.25em,
        right = 0.25em,
        top = 0.5em,
        bottom = 0.5em,
        boxrule = 0.1em,
        colframe = PLTBGColor!40!black,
        interior style={
            top color = PLTBGColor!90!black,
            bottom color = PLTBGColor!95,
        },
        valign = top,
        halign = flush left,
        halign lower = flush left,
        rounded corners,
        fontupper = \sffamily\color{PLTFGColor},
        fontlower = \sffamily\color{PLTFGColor},
        fonttitle = \sffamily\color{PLTFGColor!10},
    },%
    enumerate/.style = {
        itemize,
        enlarge top by = 1em,
        enlarge left by = 1em,
        add to width = -1em,
        lefttitle = 0.8em,
        overlay = {
            \coordinate (North West) at ($(frame.north west) + (0.05em, -0.05em)$);
            \path [fill = PLTBGColor!40!black] (North West) circle (1em);
            \path [thick, draw = PLTBGColor] (North West) circle (0.9em);
            \path [draw = PLTBGColor!40!black, line width = 0.1em, ] ($(frame.north west) + (1.15em, -0.05em)$) -- ++(-0.1em, 0) arc (0:270:1em) -- ++(0, -0.1em);
            \node[align = center, text = PLTFGColor!10] at ($(frame.north west) + (0.05em, -0.05em)$) {\theplt@BoxNumber};
        },
    },
    red box/.style = {
        left = 0.25em,
        right = 0.25em,
        top = 0.5em,
        bottom = 0.5em,
        boxrule = 0.1em,
        colframe = red,
        colback = red!5,
        valign = top,
        halign = flush left,
        halign lower = flush left,
        rounded corners,
        fontupper = \sffamily\color{.},
        fontlower = \sffamily,
        fonttitle = \sffamily,
    },
%
% grids
    raster options/.style = {
        nobeforeafter,
        raster columns = 3,
        raster equal height = rows,
        raster valign = top,
        raster force size = false,
    },
%grid enumerate default/.style = {
%    raster options,
%    raster column skip = 1.2em,
%    raster left skip = 1em,
%},
}

% Variables
\newcounter{plt@BoxNumber}

% Code
\NewDocumentCommand{\plt@ShowColorBox}{ +m }{%
    \begin{tcolorbox}[plt@@single item]
        #1
    \end{tcolorbox}%
}
\NewDocumentCommand{\plt@ShowItem}{ m m m +m m }{%
    \PLTIfType{#1}{B, AB}{%
        \tcbset{plt@@single item/.append style = {squeezed title = {#3}}}%
    }{%
        \tcbset{plt@@single item/.append style = {}}%
    }%
    \ifbool{plt@UsingBeamer}{%
        \PLTIfType{#1}{A, AB}{%
            \visible<#2>{#5{#4}}%
        }{%
            #5{#4}%
        }%
    }{%
        #5{#4}%
    }%
}

\NewDocumentEnvironment{PLTBoxRaster}{ O{} +b }{%
    \begingroup%
    \PLTGatherItems{#2}%
    \PLTResetLoop%
    \tcbset{plt@@single item/.style = {}}%
    \defcounter{plt@BoxNumber}{0}%
    \PLTBoxSet{
        itemize, % default
        #1,
    }%
    \begin{tcbraster}[
        raster options,
    %raster width fix,
    ]
        \PLTMapInline{%
            \stepcounter{plt@BoxNumber}%
            \PLTParseItemFromMacro{\typeopt}{\angleopt}{\bracketopt}{\body}{\PLTInlineItem}%
            \plt@ShowItem{\typeopt}{\angleopt}{\bracketopt}{\body}{\plt@ShowColorBox}%
            \PLTNextColor%
        }%
    \end{tcbraster}%
    \endgroup%
    }{%
}

%\NewDocumentEnvironment{PLTBoxEnumerate}{ O{} D<>{} }{%
%    \begin{PLTBoxRaster}[enumerate, #1]
%        <grid enumerate default, #2>
%            }{
%    \end{PLTBoxRaster}
%}
%
%\NewDocumentEnvironment{PLTBoxItemize}{ O{} D<>{} }{%
%    \begin{PLTBoxRaster}[itemize, #1]
%        <grid enumerate default, #2>
%            }{
%    \end{PLTBoxRaster}
%}

%\NewDocumentEnvironment{PLTBox}{ O{itemize} +b }{%
%    \begingroup%
%    \PLTGatherItems{#2}%
%    \PLTResetLoop%
%    \defcounter{plt@BoxNumber}{0}
%    \tcbset{plt@@single item/.style = {#1}}%
%    \PLTMapInline{%
%        \stepcounter{plt@BoxNumber}
%        \PLTParseItemFromMacro{\typeopt}{\angleopt}{\bracketopt}{\body}{\PLTInlineItem}%
%        \plt@ShowItem{\typeopt}{\angleopt}{\bracketopt}{\body}{\plt@ShowColorBox}%
%        \PLTNextColor%
%    }
%    }{%
%    \endgroup
%}


\endinput